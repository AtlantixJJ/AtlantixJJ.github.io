<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Detectron In a Day</title>
  <meta name="description" content="Detectron In a Day">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/jekyll/update/2018/06/05/detectron-apply.html">
  <link rel="alternate" type="application/rss+xml" title="Jianjing Xu's Blog" href="http://localhost:4000/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Jianjing Xu's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About Me</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Detectron In a Day</h1>
    <p class="post-meta"><time datetime="2018-06-05T05:03:23-04:00" itemprop="datePublished">Jun 5, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="detectron-in-a-day">Detectron In a Day</h1>

<p>By Atlantix, 2018/5/29.</p>

<h2 id="environment-configuration">Environment Configuration</h2>

<p>MSCOCO dataset is already prepared in the server.</p>

<h3 id="coco-api">COCO API</h3>

<p>Clone from its github page and build as requested.</p>

<p>Obstacle 1: <code class="highlighter-rouge">X display</code> not set properly.</p>

<p>Solution: Reinstall <code class="highlighter-rouge">xorg</code>.</p>

<p>Obstacle 2: <code class="highlighter-rouge">undefined symbol: PyFPE_jbuf</code>. A rare issue, when you compile it before you change the python library this will happen. For example, switching from anaconda3 to anaconda2. The solution is to clean all the build and make again.</p>

<h3 id="caffe2-installation-from-source">Caffe2 Installation (From Source)</h3>

<p>Do as the official website suggest:</p>

<p>https://caffe2.ai/docs/getting-started.html?platform=ubuntu&amp;configuration=compile</p>

<p>But there are many problems that force me to switch to anaconda.</p>

<p>Part of the issues are the followings:</p>

<ol>
  <li>
    <p>cmake failure: <code class="highlighter-rouge">string does not recognize sub-command APPEND</code>. Probably caused by low version of CMake. To deal with it, you need to install the latest CMake from source.</p>
  </li>
  <li>
    <p>make failure。<code class="highlighter-rouge">/usr/bin/ld: cannot find -lnvrtc</code>. After examing its code, I found <code class="highlighter-rouge">sudo</code> to be part of the failure. Use user permission to build the source will eliminate this failure.</p>
  </li>
  <li>
    <p>opencv linking failure。<code class="highlighter-rouge">/usr/local/lib/libopencv_core.so.3.4: undefined reference to dgeqrf_</code>。It is probably the problem with opencv pre-built binaries. To solve it, you need to build opencv from source.</p>
  </li>
</ol>

<p>Well, I stop at the 3rd step. It is too annoying.</p>

<h3 id="caffe2-installation-by-anaconda">Caffe2 Installation (By Anaconda)</h3>

<p>It seems that <code class="highlighter-rouge">detectron</code> only support python2. So unfortunate for Anaconda3 users.</p>

<p>There is no problem installing anaconda2, and install Caffe2 is one line:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda install -c caffe2 caffe2-cuda8.0-cudnn7
</code></pre></div></div>

<p>I notice that the official instruction suggest to add <code class="highlighter-rouge">gcc4.8</code> subfix if the GCC version is lower than 5. But if you do that, the package cannot be found. And Continue without subfix seems to be fine. Anyway.</p>

<p>But later, there is other issues with CUDA library. Lots of version problem:</p>

<ol>
  <li>
    <p>CuDNN need to be 7.</p>
  </li>
  <li>
    <p>NCCL need to be 2.</p>
  </li>
</ol>

<p>Download from NVIDIA and install to local directory solve the problem. I suppose you do not have sudo permission, in this case fake a <code class="highlighter-rouge">usr/local/</code> in your local directory will help.</p>

<p>Then I verified the installation. Successful!</p>

<h3 id="compile-detectron">Compile Detectron</h3>

<p>The instruction is very simple:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install -r ./requirements.txt --user
make
python2 detectron/tests/test_spatial_narrow_as_op.py
</code></pre></div></div>

<p>However <code class="highlighter-rouge">pip install -r ./requirements.txt --user</code> cause serious problem in my case. It seems that pip fails to recognize conda, and the libraries are installed twice. As a result, the whole python environment breaks. It is more convenient reinstalling anaconda than repairing it.</p>

<p>After this, I continue without error.</p>

<h3 id="train-maskrcnn-with-detectron">Train MaskRCNN with Detectron</h3>

<p>Inference:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python2 tools/infer_simple.py \
    --cfg configs/12_2017_baselines/e2e_mask_rcnn_R-101-FPN_2x.yaml \
    --output-dir ./log/detectron-visualizations \
    --image-ext jpg \
    --wts ../model/model_final.pkl \
    demo
</code></pre></div></div>

<p>Train (End to End):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python2 tools/train_net.py \
    --cfg configs/my/e2e_mask_rcnn_R-50-FPN_1x.yaml \
    OUTPUT_DIR ./log/detectron-mye2e_2
</code></pre></div></div>

<p>Modifications needed are:</p>

<ol>
  <li>
    <p>Reduce NUM_GPU to suit your machine.</p>
  </li>
  <li>
    <p>Add dataset in <code class="highlighter-rouge">dataset_catalog.py</code> if your dataset is not at the particular position.</p>
  </li>
  <li>
    <p>Modify dataset name too.</p>
  </li>
  <li>
    <p>Learning rate schedule modification. If you are not using 8 GPUs, then you should do a linear learning rate schedule stretch according to <code class="highlighter-rouge">getting_started</code> section.</p>
  </li>
</ol>

<h3 id="experiment-log">Experiment Log</h3>

<h4 id="expr-1">Expr 1</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python2 tools/train_net.py \
    --multi-gpu-testing \
    --cfg configs/my/e2e_mask_rcnn_R-50-FPN_1x.yaml \
    OUTPUT_DIR ./log/detectron-mye2e_2
</code></pre></div></div>

<p>In this experiment, I forgot to stretch the learning rate schedule, and it failed with learning, resulting in <code class="highlighter-rouge">Negative Area</code> fault.</p>

<h4 id="expr-2">Expr 2</h4>

<p>All the settings are done properly. But the training takes totally 4 days on 2 GPUs.</p>

<p>result:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.294
Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.505
Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.304
Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.116
Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.308
Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.427
Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.266
Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.411
Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.430
Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.234
Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.466
Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.573
INFO json_dataset_evaluator.py: 122: Wrote json eval results to: ./log/detectron-mye2e_2/test/coco_my_val/generalized_rcnn/segmentation_results.pkl
INFO task_evaluation.py:  66: Evaluating segmentations is done!
INFO task_evaluation.py: 181: copypaste: Dataset: coco_my_val
INFO task_evaluation.py: 183: copypaste: Task: box
INFO task_evaluation.py: 186: copypaste: AP,AP50,AP75,APs,APm,APl
INFO task_evaluation.py: 187: copypaste: 0.3222,0.5410,0.3403,0.1729,0.3419,0.4060
INFO task_evaluation.py: 183: copypaste: Task: mask
INFO task_evaluation.py: 186: copypaste: AP,AP50,AP75,APs,APm,APl
INFO task_evaluation.py: 187: copypaste: 0.2940,0.5049,0.3039,0.1163,0.3080,0.4274
</code></pre></div></div>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Jianjing Xu's Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Jianjing Xu's Blog</li>
          <li><a href="mailto:jx2386@columbia.edu">jx2386@columbia.edu</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/AtlantixJJ"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">AtlantixJJ</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
